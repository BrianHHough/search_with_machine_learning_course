# Project: Search with Query Understanding

Train a fastText classification model on queries (rather than product names).

# Level 1: Query Classification

Run:
```bash
python create_labeled_queries.py
```

Confirm output:
Run:
```bash
wc /workspace/datasets/fasttext/labeled_queries.txt
```
Output:
```bash
 1854998  5396970 67889572 /workspace/datasets/fasttext/labeled_queries.txt
```

Run:
```bash
cut -d' ' -f1 /workspace/datasets/fasttext/labeled_queries.txt | sort | uniq | wc
```
Output:
```bash
   1486    1486   37488
```
^ Computes the number of distinct labels (category ids) - nearly 1.5k, which is too many to train an accurate model b/c labels are mostly associated with only one or several queries.

## Task 1: Prune category taxonomy tree to reduce the number of distinct labels
Need to make each category associated with a minimum number of queries (e.g. 100) - change threshold to observe its impact on model accuracy

Goal:
- Convert all letters to lowercase.
- Treat any character that is not a number or letter as a space.
- Trim multiple spaces to a single space.
- Use the NLTK stemmer to stem all query tokens.

File that was updated here: `create_labeled_queries.py`

Execute it:
Run:
```bash
python create_labeled_queries.py
```

Check if it worked:
Run
```bash
vim /workspace/datasets/fasttext/labeled_queries.txt
```
Output:
```bash
__label__abcat0101001 television panason 50 pulgada
__label__abcat0101001 sharp
__label__abcat0101001 rca
__label__abcat0101001 samsung 40
__label__abcat0101001 lcd tv
__label__abcat0101001 lcd tv
__label__abcat0101001 panason 3d tv
__label__abcat0101001 viera
__label__abcat0101001 lg
__label__abcat0101001 lcd tv
__label__abcat0101001 toshiba 55 class 1080p 120hz lcd hdtv
__label__abcat0101001 lcd tv
__label__abcat0101001 lcd tv
__label__abcat0101001 lg 65lw6500
__label__abcat0101001 lg televis
__label__abcat0101001 2622037 2127204 2127213 2121716 2138291
__label__abcat0101001 visio 3d
__label__abcat0101001 2622037 2127204 2127213 2121716 2138291
__label__abcat0101001 lcd tv
__label__abcat0101001 sharp
__label__abcat0101001 pn43d450
__label__abcat0101001 samsung 55 led
__label__abcat0101001 lg 55 3d
__label__abcat0101001 lg 55 3d
__label__abcat0101001 appl ipod nano
__label__abcat0101001 lcd tv
__label__abcat0101001 plasma
__label__abcat0101001 samsung 59
__label__abcat0101001 un55d6050
__label__abcat0101001 onlinemidnightsal home theater
__label__abcat0101001 samsung d6000
__label__abcat0101001 samsung 19 led
__label__abcat0101001 lcd tv
__label__abcat0101001 lcd tv
__label__abcat0101001 2622037 2127204 2127213 2121716 2138291
__label__abcat0101001 soni bravia 55
__label__abcat0101001 lcd tv
__label__abcat0101001 googl tv
```

### Check if query normalized in txt:

Created a file to check if the normalized version of a specific query, such as "Beats By Dr. Dre- Monster Pro Over-the-Ear Headphones", exists in the `labeled_queries.txt` file, which was generated by `create_labeled_queries.py` script.


**TEST**: "Beats By Dr. Dre- Monster Pro Over-the-Ear Headphones" ✅ (test passed)
- The normalized version of this query should be in there
Run:
```bash
python check_if_query_normalized.py
```
Output:
```bash
Query normalized correctly in labeled_queries.txt: True
Original Query: Beats By Dr. Dre- Monster Pro Over-the-Ear Headphones -
Normalized Query: beat by dr dre monster pro over the ear headphon
```

**TEST**: "Beats By Dr. Dre- Monster 22222 Pro Over-the-Ear Headphones -" ❌ (test passed)
- Definitely NOT in the `labeled_queries.txt` file
Run:
```bash
python check_if_query_normalized.py
```
Output:
```bash
Query normalized correctly in labeled_queries.txt: False
Original Query: Beats By Dr. Dre- Monster 22222 Pro Over-the-Ear Headphones -
Normalized Query: beat by dr dre monster 22222 pro over the ear headphon
```

### Compute the query counts for all categories

Created a script called: `check_query_counts.py`

Run:
```bash
python check_query_counts.py
```
Output:
```bash
                             label                            query  counts
0            __label__abcat0011000                      dvd portabl       1
1            __label__abcat0011000                             pink       8
2            __label__abcat0011000  pink phillip portabl dvd player       1
3            __label__abcat0011000               portabl dvd player       4
4            __label__abcat0011000          portabl pink dvd player       1
...                            ...                              ...     ...
321140  __label__pcmcat99000050002                            rotor       1
321141  __label__pcmcat99000050002                           router       4
321142  __label__pcmcat99000050002                      router wire       2
321143  __label__pcmcat99000050002                      wire router       5
321144  __label__pcmcat99000050002                  wireless router       4
```

### Confirm a specific label and count its number of queries

Created `check_query_specific.py` file to tally up all of the queries for label `__label__abcat0701001`:

Run:
```bash
python check_query_specific.py
```
Output:
```bash
Count for __label__abcat0701001 (XBox 360 Consoles): 13830
```

ALTERNATIVE WAY TO CHECK FOR THE LABELS: For the script, if it was updated to output the label... you'll see this (which is interesting because it shows the items all being related to XBox)

```py
import pandas as pd
import json

def get_data_for_specific_label(file_path, label):
    try:
        with open(file_path, 'r') as file:
            lines = file.readlines()

        # Split each line into label and query
        labels, queries = [], []
        for line in lines:
            split_line = line.strip().split(' ', 1)
            labels.append(split_line[0])
            queries.append(split_line[1] if len(split_line) > 1 else '')

        # Create DataFrame
        data = pd.DataFrame({'label': labels, 'query': queries})

        # Filter data for the specific label
        label_data = data[data['label'] == label]

        # Convert to JSON
        label_data_json = label_data.to_json(orient='records')
        return label_data_json
    except Exception as e:
        print("Error reading file:", e)
        return None

# Example usage
file_path = '/workspace/datasets/fasttext/labeled_queries.txt'
specific_label = '__label__abcat0701001'  # Label for XBox 360 Consoles
label_data_json = get_data_for_specific_label(file_path, specific_label)
print(f"Data for {specific_label}:", label_data_json)
```

Output from running this for reference:
```json
...
,"query":"xbox kinect"},{"label":"__label__abcat0701001","query":"kinect"},{"label":"__label__abcat0701001","query":"xbox 360"},{"label":"__label__abcat0701001","query":"xbox 360"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"xbox 360"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"xbox 360"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"x box360"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"xbox 360 system"},{"label":"__label__abcat0701001","query":"gear of war xbox 360 consol bundl"},{"label":"__label__abcat0701001","query":"summersal comput 20110826"},{"label":"__label__abcat0701001","query":"xbox 360 kinect"},{"label":"__label__abcat0701001","query":"xbox 360 kinect"},{"label":"__label__abcat0701001","query":"gear of war 3"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"x box 360 consol"},{"label":"__label__abcat0701001","query":"xbox kinect"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"xbox 360"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"xbox 360"},{"label":"__label__abcat0701001","query":"xbox"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"tv"},{"label":"__label__abcat0701001","query":"xbox 360"},{"label":"__label__abcat0701001","query":"gear of war 3"},{"label":"__label__abcat0701001","query":"xbox"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"fallsal televis 20110930"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"xbox360"},{"label":"__label__abcat0701001","query":"xbox360 bundl"},{"label":"__label__abcat0701001","query":"kinect"},{"label":"__label__abcat0701001","query":"xbox 360"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"xbox 360 consol"},{"label":"__label__abcat0701001","query":"xbox"},{"label":"__label__abcat0701001","query":"xbox 360"},{"label":"__label__abcat0701001","query":"jame bond"},{"label":"__label__abcat0701001","query":"xbox360 kinect packag"},{"label":"__label__abcat0701001","query":"gear of war"},{"label":"__label__abcat0701001","query":"xbox 360 system"},{"label":"__label__abcat0701001","query":"xbox"}]
```
^ Notice that all of these queries are related to XBox


### Create Pruned and Labeled Queries in fastText format

Created a file: `create_pruned_labeled_queries.py`

Before pruning:
```bash
Number of unique categories: 1486
                             label                            query  counts
0            __label__abcat0011000                      dvd portabl       1
1            __label__abcat0011000                             pink       8
2            __label__abcat0011000  pink phillip portabl dvd player       1
3            __label__abcat0011000               portabl dvd player       4
4            __label__abcat0011000          portabl pink dvd player       1
...                            ...                              ...     ...
321140  __label__pcmcat99000050002                            rotor       1
321141  __label__pcmcat99000050002                           router       4
321142  __label__pcmcat99000050002                      router wire       2
321143  __label__pcmcat99000050002                      wire router       5
321144  __label__pcmcat99000050002                  wireless router       4

[321145 rows x 3 columns]
```

After pruning - threshold at 100:
```bash
Number of unique categories before pruning: 1486
Number of unique categories after pruning: 818
                             label                        query  counts
25           __label__abcat0101001                                   21
26           __label__abcat0101001                   0 interest       1
27           __label__abcat0101001  1 3 hd mi cabl for lg 1080p       1
28           __label__abcat0101001        1 milisecond delay tv       1
29           __label__abcat0101001                 10 15 lcd tv       1
...                            ...                          ...     ...
321114  __label__pcmcat68700050002                  tv stand 55       1
321115  __label__pcmcat68700050002              tv stand for 55       1
321116  __label__pcmcat68700050002      tv stand for 55 inch tv       1
321117  __label__pcmcat68700050002                      tv tabl       3
321118  __label__pcmcat68700050002                          usb       1

[311053 rows x 3 columns]
```

After pruning - threshold at 1000:
```bash
Number of unique categories before pruning: 1486
Number of unique categories after pruning: 298
                              label                        query  counts
25            __label__abcat0101001                                   21
26            __label__abcat0101001                   0 interest       1
27            __label__abcat0101001  1 3 hd mi cabl for lg 1080p       1
28            __label__abcat0101001        1 milisecond delay tv       1
29            __label__abcat0101001                 10 15 lcd tv       1
...                             ...                          ...     ...
320647  __label__pcmcat254000050005             wireless surveil       5
320648  __label__pcmcat254000050005      wireless surveil camera       2
320649  __label__pcmcat254000050005        wireless video camera       1
320650  __label__pcmcat254000050005             wireless web cam       2
320651  __label__pcmcat254000050005                    zonealarm      88

[252961 rows x 3 columns]
```




## Task 2: Train a query classifier.
Training a query classifier using fastText

### Shuffle the Labeled Data:
- Create a shuffled version of the labeled data in `shuffled_labeled_queries.txt`
Run:
```bash
shuf --random-source=<(seq 999999) /workspace/datasets/fasttext/labeled_queries.txt -o /workspace/datasets/fasttext/shuffled_labeled_queries.txt
```

### Split the data:
- Extract a portion of the shuffled data for training and testing
Run:
```bash
head -n 50000 /workspace/datasets/fasttext/shuffled_labeled_queries.txt > /workspace/datasets/fasttext/training_data.txt
tail -n 10000 /workspace/datasets/fasttext/shuffled_labeled_queries.txt > /workspace/datasets/fasttext/testing_data.txt
```

### Train the model on training data:
Run:
```bash
~/fastText-0.9.2/fasttext supervised -input /workspace/datasets/fasttext/training_data.txt -output /workspace/datasets/fasttext/query_classifier
```
^ This said it was expected to run for `4h18m18s` (~4.5 hours), so I can reduce the number of epochs to speed up.


```bash
~/fastText-0.9.2/fasttext supervised -input /workspace/datasets/fasttext/training_data.txt -output /workspace/datasets/fasttext/query_classifier -epoch 2
```
^ This was expected to run for `1h25m 7s` (~1.5 hours)

```bash
~/fastText-0.9.2/fasttext supervised -input /workspace/datasets/fasttext/training_data.txt -output /workspace/datasets/fasttext/query_classifier -epoch 1
```
^ This is 30 minutes


# Level 2: Integrating Query Classification with Search
